"use strict";const d=require("electron"),p=require("path"),c=require("fs"),R=require("os"),S=require("crypto"),a=[];for(let r=0;r<256;++r)a.push((r+256).toString(16).slice(1));function E(r,o=0){return(a[r[o+0]]+a[r[o+1]]+a[r[o+2]]+a[r[o+3]]+"-"+a[r[o+4]]+a[r[o+5]]+"-"+a[r[o+6]]+a[r[o+7]]+"-"+a[r[o+8]]+a[r[o+9]]+"-"+a[r[o+10]]+a[r[o+11]]+a[r[o+12]]+a[r[o+13]]+a[r[o+14]]+a[r[o+15]]).toLowerCase()}const g=new Uint8Array(256);let m=g.length;function I(){return m>g.length-16&&(S.randomFillSync(g),m=0),g.slice(m,m+=16)}const v={randomUUID:S.randomUUID};function h(r,o,i){var n;if(v.randomUUID&&!r)return v.randomUUID();r=r||{};const e=r.random??((n=r.rng)==null?void 0:n.call(r))??I();if(e.length<16)throw new Error("Random bytes length must be >= 16");return e[6]=e[6]&15|64,e[8]=e[8]&63|128,E(e)}const f=p.join(R.homedir(),".loco"),w=p.join(f,"models"),b=p.join(f,"images"),u=p.join(f,"videos");function F(){try{c.existsSync(f)||c.mkdirSync(f),c.existsSync(w)||c.mkdirSync(w),c.existsSync(b)||c.mkdirSync(b),c.existsSync(u)||c.mkdirSync(u)}catch(r){console.error("Error creating app directories:",r)}}d.app.whenReady().then(()=>{F(),d.protocol.registerFileProtocol("app-file",(i,e)=>{const n=i.url.substring(10);try{const t=decodeURI(n);if(!c.existsSync(t))return console.error("File not found:",t),e({error:-2});const s=p.extname(t).toLowerCase();let l="application/octet-stream";return s===".jpg"||s===".jpeg"?l="image/jpeg":s===".png"?l="image/png":s===".gif"?l="image/gif":s===".webp"?l="image/webp":s===".svg"&&(l="image/svg+xml"),e({path:t,mimeType:l})}catch(t){return console.error("Protocol handler error:",t),e({error:-2})}});const r=new d.BrowserWindow({show:!0,transparent:!0,frame:!1,center:!0,hasShadow:!1,movable:!1,alwaysOnTop:!1,focusable:!0,icon:p.join(process.cwd(),"loco-icon.icns"),webPreferences:{sandbox:!0,webviewTag:!0,nodeIntegration:!1,contextIsolation:!0,preload:p.join(__dirname,"preload.js"),webSecurity:!0}});r.webContents.session.webRequest.onHeadersReceived((i,e)=>{i.url.startsWith("blob:")?e({responseHeaders:{...i.responseHeaders,"Access-Control-Allow-Origin":["*"],"Access-Control-Allow-Methods":["GET, POST, OPTIONS"],"Access-Control-Allow-Headers":["Content-Type, Authorization"],"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}}):e({responseHeaders:{...i.responseHeaders,"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}})}),r.webContents.session.webRequest.onBeforeRequest((i,e)=>{i.url.startsWith("app-file://"),e({})});const o=d.session.fromPartition("persist:webviewsession");o.protocol.registerFileProtocol("app-file",(i,e)=>{const n=i.url.substring(10);try{const t=decodeURI(n);if(!c.existsSync(t))return console.error("File not found:",t),e({error:-2});const s=p.extname(t).toLowerCase();let l="application/octet-stream";return s===".jpg"||s===".jpeg"?l="image/jpeg":s===".png"?l="image/png":s===".gif"?l="image/gif":s===".webp"?l="image/webp":s===".svg"&&(l="image/svg+xml"),e({path:t,mimeType:l})}catch(t){return console.error("Protocol handler error in webview session:",t),e({error:-2})}}),o.webRequest.onHeadersReceived((i,e)=>{e({responseHeaders:{...i.responseHeaders,"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}})}),o.setPermissionRequestHandler((i,e,n)=>{i.getURL(),n(e==="media"||e==="mediaKeySystem"||e==="geolocation"||e==="notifications"||e==="fullscreen")}),r.maximize(),r.show(),r.setFocusable(!0),process.env.VITE_DEV_SERVER_URL?r.loadURL(process.env.VITE_DEV_SERVER_URL):r.loadFile("dist/index.html"),d.ipcMain.handle("save-model-file",async(i,e,n)=>{try{const t=`${h()}-${n}`,s=p.join(w,t);return c.writeFileSync(s,Buffer.from(e)),`app-file://${s}`}catch(t){throw console.error("Error saving model file:",t),t}}),d.ipcMain.handle("save-image-file",async(i,e,n)=>{try{const t=`${h()}-${n}`,s=p.join(b,t);return c.writeFileSync(s,Buffer.from(e)),`app-file://${s}`}catch(t){throw console.error("Error saving image file:",t),t}}),d.ipcMain.handle("save-video-file",async(i,e,n)=>{try{const t=`${h()}-${n}`,s=p.join(u,t);return c.writeFileSync(s,Buffer.from(e)),`app-file://${s}`}catch(t){throw console.error("Error saving video file:",t),t}}),d.ipcMain.handle("list-videos-from-disk",async i=>{try{return{success:!0,videos:c.readdirSync(u).filter(s=>{const l=p.extname(s).toLowerCase();return[".mp4",".webm",".mov",".avi",".mkv"].includes(l)}).map(s=>{const l=p.join(u,s),y=c.statSync(l),x=s.includes("-")?s.substring(s.indexOf("-")+1):s;return{id:h(),fileName:x,url:`app-file://${l}`,thumbnailUrl:"",filePath:l,fileSize:y.size,createdAt:y.birthtime.toISOString(),modifiedAt:y.mtime.toISOString(),type:"video"}})}}catch(e){return console.error("Error listing videos from disk:",e),{success:!1,videos:[],error:e.message}}}),d.ipcMain.handle("test-file-access",async(i,e)=>{try{const n=c.existsSync(e);if(n){const t=c.statSync(e);return{exists:n,size:t.size,isFile:t.isFile()}}return{exists:n}}catch(n){throw console.error(`Erro ao verificar arquivo ${e}:`,n),n}}),d.ipcMain.handle("read-file-as-buffer",async(i,e)=>{try{if(!c.existsSync(e))throw new Error(`Arquivo n√£o encontrado: ${e}`);return c.readFileSync(e)}catch(n){throw console.error(`Erro ao ler arquivo ${e}:`,n),n}})});
