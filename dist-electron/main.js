"use strict";const n=require("electron"),g=require("path"),d=require("fs"),A=require("os"),x=require("crypto"),u=[];for(let t=0;t<256;++t)u.push((t+256).toString(16).slice(1));function E(t,a=0){return(u[t[a+0]]+u[t[a+1]]+u[t[a+2]]+u[t[a+3]]+"-"+u[t[a+4]]+u[t[a+5]]+"-"+u[t[a+6]]+u[t[a+7]]+"-"+u[t[a+8]]+u[t[a+9]]+"-"+u[t[a+10]]+u[t[a+11]]+u[t[a+12]]+u[t[a+13]]+u[t[a+14]]+u[t[a+15]]).toLowerCase()}const b=new Uint8Array(256);let m=b.length;function O(){return m>b.length-16&&(x.randomFillSync(b),m=0),b.slice(m,m+=16)}const C={randomUUID:x.randomUUID};function y(t,a,o){var r;if(C.randomUUID&&!t)return C.randomUUID();t=t||{};const e=t.random??((r=t.rng)==null?void 0:r.call(t))??O();if(e.length<16)throw new Error("Random bytes length must be >= 16");return e[6]=e[6]&15|64,e[8]=e[8]&63|128,E(e)}const h=g.join(A.homedir(),".loco"),S=g.join(h,"models"),v=g.join(h,"images"),f=g.join(h,"videos");function $(){try{d.existsSync(h)||d.mkdirSync(h),d.existsSync(S)||d.mkdirSync(S),d.existsSync(v)||d.mkdirSync(v),d.existsSync(f)||d.mkdirSync(f)}catch(t){console.error("Error creating app directories:",t)}}const l={log:(...t)=>{process.env.NODE_ENV==="development"&&console.log(...t)},error:(...t)=>{console.error(...t)}};let p=null;n.app.whenReady().then(()=>{$(),n.protocol.registerFileProtocol("app-file",(o,e)=>{const r=o.url.substring(10);try{const s=decodeURI(r);if(!d.existsSync(s))return console.error("File not found:",s),e({error:-2});const i=g.extname(s).toLowerCase();let c="application/octet-stream";return i===".jpg"||i===".jpeg"?c="image/jpeg":i===".png"?c="image/png":i===".gif"?c="image/gif":i===".webp"?c="image/webp":i===".svg"&&(c="image/svg+xml"),e({path:s,mimeType:c})}catch(s){return console.error("Protocol handler error:",s),e({error:-2})}});const t=new n.BrowserWindow({show:!0,transparent:!0,frame:!1,center:!0,hasShadow:!1,movable:!0,alwaysOnTop:!0,focusable:!0,skipTaskbar:!0,titleBarStyle:"hidden",icon:g.join(process.cwd(),"loco-icon.icns"),webPreferences:{sandbox:!0,webviewTag:!0,nodeIntegration:!1,contextIsolation:!0,preload:g.join(__dirname,"preload.js"),webSecurity:!0}});t.webContents.on("did-finish-load",()=>{I(t)}),t.on("closed",()=>{p&&!p.isDestroyed()&&(l.log("Destroying tray icon on window close"),p.destroy(),p=null)}),t.setAlwaysOnTop(!0,"floating",1),t.webContents.session.webRequest.onHeadersReceived((o,e)=>{o.url.startsWith("blob:")?e({responseHeaders:{...o.responseHeaders,"Access-Control-Allow-Origin":["*"],"Access-Control-Allow-Methods":["GET, POST, OPTIONS"],"Access-Control-Allow-Headers":["Content-Type, Authorization"],"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}}):e({responseHeaders:{...o.responseHeaders,"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}})}),t.webContents.session.webRequest.onBeforeRequest((o,e)=>{o.url.startsWith("app-file://"),e({})});const a=n.session.fromPartition("persist:webviewsession");a.protocol.registerFileProtocol("app-file",(o,e)=>{const r=o.url.substring(10);try{const s=decodeURI(r);if(!d.existsSync(s))return console.error("File not found:",s),e({error:-2});const i=g.extname(s).toLowerCase();let c="application/octet-stream";return i===".jpg"||i===".jpeg"?c="image/jpeg":i===".png"?c="image/png":i===".gif"?c="image/gif":i===".webp"?c="image/webp":i===".svg"&&(c="image/svg+xml"),e({path:s,mimeType:c})}catch(s){return console.error("Protocol handler error in webview session:",s),e({error:-2})}}),a.webRequest.onHeadersReceived((o,e)=>{e({responseHeaders:{...o.responseHeaders,"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}})}),a.setPermissionRequestHandler((o,e,r)=>{const s=o.getURL();l.log(`Permission request: ${e} for ${s}`),e==="media"||e==="mediaKeySystem"||e==="geolocation"||e==="notifications"||e==="fullscreen"||e==="display-capture"||e==="pointerLock"?(l.log(`Granting permission: ${e}`),r(!0)):(l.log(`Denying permission: ${e}`),r(!1))}),t.webContents.session.setPermissionRequestHandler((o,e,r)=>{o.getURL(),e==="media"||e==="mediaKeySystem"||e==="geolocation"||e==="notifications"||e==="fullscreen"||e==="display-capture"||e==="pointerLock"?(l.log(`Granting permission: ${e}`),r(!0)):(l.log(`Denying permission: ${e}`),r(!1))}),t.webContents.session.setPermissionCheckHandler((o,e)=>e==="media"||e==="pointerLock"),t.maximize(),t.show(),t.setFocusable(!0),t.setAlwaysOnTop(!0,"floating",1),T(t),process.env.VITE_DEV_SERVER_URL?t.loadURL(process.env.VITE_DEV_SERVER_URL):t.loadFile("dist/index.html"),n.ipcMain.handle("save-model-file",async(o,e,r)=>{try{const s=`${y()}-${r}`,i=g.join(S,s);return d.writeFileSync(i,Buffer.from(e)),`app-file://${i}`}catch(s){throw l.error("Error saving model file:",s),s}}),n.ipcMain.handle("save-image-file",async(o,e,r)=>{try{const s=`${y()}-${r}`,i=g.join(v,s);return d.writeFileSync(i,Buffer.from(e)),`app-file://${i}`}catch(s){throw console.error("Error saving image file:",s),s}}),n.ipcMain.handle("save-video-file",async(o,e,r)=>{try{const s=`${y()}-${r}`,i=g.join(f,s);return d.writeFileSync(i,Buffer.from(e)),`app-file://${i}`}catch(s){throw console.error("Error saving video file:",s),s}}),n.ipcMain.handle("list-videos-from-disk",async o=>{try{return{success:!0,videos:d.readdirSync(f).filter(i=>{const c=g.extname(i).toLowerCase();return[".mp4",".webm",".mov",".avi",".mkv"].includes(c)}).map(i=>{const c=g.join(f,i),w=d.statSync(c),R=i.includes("-")?i.substring(i.indexOf("-")+1):i;return{id:y(),fileName:R,url:`app-file://${c}`,thumbnailUrl:"",filePath:c,fileSize:w.size,createdAt:w.birthtime.toISOString(),modifiedAt:w.mtime.toISOString(),type:"video"}})}}catch(e){return l.error("Error listing videos from disk:",e),{success:!1,videos:[],error:e.message}}}),n.ipcMain.handle("test-file-access",async(o,e)=>{try{const r=d.existsSync(e);if(r){const s=d.statSync(e);return{exists:r,size:s.size,isFile:s.isFile()}}return{exists:r}}catch(r){throw console.error(`Erro ao verificar arquivo ${e}:`,r),r}}),n.ipcMain.handle("read-file-as-buffer",async(o,e)=>{try{if(!d.existsSync(e))throw new Error(`Arquivo nÃ£o encontrado: ${e}`);return d.readFileSync(e)}catch(r){throw l.error(`Erro ao ler arquivo ${e}:`,r),r}}),n.ipcMain.handle("get-screen-sources",async()=>{try{l.log("Electron: Fetching screen sources");const o=await n.desktopCapturer.getSources({types:["screen","window"],thumbnailSize:{width:150,height:150},fetchWindowIcons:!0});return l.log(`Electron: Found ${o.length} screen sources:`,o.map(e=>e.name)),o.map(e=>({id:e.id,name:e.name,display_id:e.display_id,thumbnail:e.thumbnail.toDataURL(),appIcon:e.appIcon?e.appIcon.toDataURL():null}))}catch(o){throw l.error("Electron: Error getting screen sources:",o),o}}),n.ipcMain.handle("reload-app",()=>{l.log("Reloading application..."),n.app.relaunch(),n.app.exit(0)}),n.ipcMain.handle("toggle-always-on-top",(o,e)=>(l.log(`Setting always-on-top: ${e}`),t.setAlwaysOnTop(e,"floating",1),t.isAlwaysOnTop())),n.app.on("will-quit",()=>{n.globalShortcut.unregisterAll(),p&&!p.isDestroyed()&&(l.log("Destroying tray icon on app quit"),p.destroy(),p=null)}),n.ipcMain.on("toggle-interview-assistant",()=>{t.webContents.send("global-shortcut","toggle-interview-assistant")}),n.ipcMain.on("capture-screenshot",()=>{t.webContents.send("global-shortcut","capture-screenshot")}),n.ipcMain.on("generate-solution",()=>{t.webContents.send("global-shortcut","generate-solution")}),n.ipcMain.on("set-always-on-top",(o,e)=>{e?t.setAlwaysOnTop(!0,"floating",1):t.setAlwaysOnTop(!1),o.returnValue=t.isAlwaysOnTop()}),n.ipcMain.handle("get-always-on-top",()=>t.isAlwaysOnTop())});function I(t){if(!t||t.isDestroyed()){l.error("Cannot create tray icon: window is not available");return}p&&!p.isDestroyed()&&(l.log("Destroying existing tray icon to prevent duplicates"),p.destroy(),p=null);const a=g.join(process.cwd(),"loco-icon.png");let o;try{if(o=n.nativeImage.createFromPath(a),o.isEmpty()){l.log("Tray icon not found, using fallback"),o=n.nativeImage.createEmpty();const r=16;o=n.nativeImage.createFromBuffer(Buffer.from(`<svg width="${r}" height="${r}" viewBox="0 0 ${r} ${r}" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="${r}" height="${r}" rx="${r/4}" fill="#FF5A5A"/>
          <text x="${r/2}" y="${r*.75}" font-family="Arial" font-size="${r*.7}" text-anchor="middle" fill="white">L</text>
        </svg>`))}}catch(r){l.error("Error creating tray icon:",r),o=n.nativeImage.createEmpty()}o=o.resize({width:16,height:16}),p=new n.Tray(o),p.setToolTip("Loco App");const e=n.Menu.buildFromTemplate([{label:"Show App",click:()=>{t.show()}},{label:"Always on Top",type:"checkbox",checked:t.isAlwaysOnTop(),click:r=>{t.setAlwaysOnTop(r.checked,"floating",1)}},{type:"separator"},{label:"Global Shortcuts:",enabled:!1},{label:"Cmd+Shift+Space: Show/Hide App",enabled:!1},{label:"Cmd+B: Toggle Interview Assistant",enabled:!1},{label:"Cmd+H: Capture Screenshot",enabled:!1},{label:"Cmd+Enter: Generate Solution",enabled:!1},{type:"separator"},{label:"Quit",click:()=>{n.app.quit()}}]);p.setContextMenu(e),p.on("click",()=>{t.isVisible()?t.hide():t.show()})}function T(t){n.globalShortcut.unregisterAll(),n.globalShortcut.register("CommandOrControl+Shift+Space",()=>{l.log("Global shortcut triggered: CommandOrControl+Shift+Space"),t.isVisible()?t.hide():t.show()}),n.globalShortcut.register("CommandOrControl+B",()=>{l.log("Global shortcut triggered: CommandOrControl+B"),t.webContents.send("global-shortcut","toggle-interview-assistant")}),n.globalShortcut.register("CommandOrControl+H",()=>{l.log("Global shortcut triggered: CommandOrControl+H"),t.webContents.send("global-shortcut","capture-screenshot")}),n.globalShortcut.register("CommandOrControl+Return",()=>{l.log("Global shortcut triggered: CommandOrControl+Return"),t.webContents.send("global-shortcut","generate-solution")}),(!n.globalShortcut.isRegistered("CommandOrControl+Shift+Space")||!n.globalShortcut.isRegistered("CommandOrControl+B")||!n.globalShortcut.isRegistered("CommandOrControl+H")||!n.globalShortcut.isRegistered("CommandOrControl+Return"))&&l.error("Global shortcut registration failed")}
