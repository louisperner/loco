"use strict";const p=require("electron"),u=require("path"),c=require("fs"),w=require("crypto"),l=[];for(let t=0;t<256;++t)l.push((t+256).toString(16).slice(1));function v(t,n=0){return(l[t[n+0]]+l[t[n+1]]+l[t[n+2]]+l[t[n+3]]+"-"+l[t[n+4]]+l[t[n+5]]+"-"+l[t[n+6]]+l[t[n+7]]+"-"+l[t[n+8]]+l[t[n+9]]+"-"+l[t[n+10]]+l[t[n+11]]+l[t[n+12]]+l[t[n+13]]+l[t[n+14]]+l[t[n+15]]).toLowerCase()}const d=new Uint8Array(256);let f=d.length;function S(){return f>d.length-16&&(w.randomFillSync(d),f=0),d.slice(f,f+=16)}const g={randomUUID:w.randomUUID};function m(t,n,i){var s;if(g.randomUUID&&!t)return g.randomUUID();t=t||{};const e=t.random??((s=t.rng)==null?void 0:s.call(t))??S();if(e.length<16)throw new Error("Random bytes length must be >= 16");return e[6]=e[6]&15|64,e[8]=e[8]&63|128,v(e)}const h=u.join(p.app.getPath("userData"),"assets"),b=u.join(h,"models"),y=u.join(h,"images");function x(){[h,b,y].forEach(t=>{c.existsSync(t)||c.mkdirSync(t,{recursive:!0})})}p.app.whenReady().then(()=>{x(),p.protocol.registerFileProtocol("app-file",(i,e)=>{const s=i.url.substring(10);try{const r=decodeURI(s);if(!c.existsSync(r))return console.error("File not found:",r),e({error:-2});const o=u.extname(r).toLowerCase();let a="application/octet-stream";return o===".jpg"||o===".jpeg"?a="image/jpeg":o===".png"?a="image/png":o===".gif"?a="image/gif":o===".webp"?a="image/webp":o===".svg"&&(a="image/svg+xml"),e({path:r,mimeType:a})}catch(r){return console.error("Protocol handler error:",r),e({error:-2})}});const t=new p.BrowserWindow({show:!0,transparent:!0,frame:!1,center:!0,hasShadow:!1,movable:!1,alwaysOnTop:!1,focusable:!0,icon:u.join(process.cwd(),"loco-icon.icns"),webPreferences:{sandbox:!0,webviewTag:!0,nodeIntegration:!1,contextIsolation:!0,preload:u.join(__dirname,"preload.js"),webSecurity:!0}});t.webContents.session.webRequest.onHeadersReceived((i,e)=>{i.url.startsWith("blob:")?e({responseHeaders:{...i.responseHeaders,"Access-Control-Allow-Origin":["*"],"Access-Control-Allow-Methods":["GET, POST, OPTIONS"],"Access-Control-Allow-Headers":["Content-Type, Authorization"],"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}}):e({responseHeaders:{...i.responseHeaders,"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}})}),t.webContents.session.webRequest.onBeforeRequest((i,e)=>{i.url.startsWith("app-file://"),e({})});const n=p.session.fromPartition("persist:webviewsession");n.protocol.registerFileProtocol("app-file",(i,e)=>{const s=i.url.substring(10);try{const r=decodeURI(s);if(!c.existsSync(r))return console.error("File not found:",r),e({error:-2});const o=u.extname(r).toLowerCase();let a="application/octet-stream";return o===".jpg"||o===".jpeg"?a="image/jpeg":o===".png"?a="image/png":o===".gif"?a="image/gif":o===".webp"?a="image/webp":o===".svg"&&(a="image/svg+xml"),e({path:r,mimeType:a})}catch(r){return console.error("Protocol handler error in webview session:",r),e({error:-2})}}),n.webRequest.onHeadersReceived((i,e)=>{e({responseHeaders:{...i.responseHeaders,"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}})}),n.setPermissionRequestHandler((i,e,s)=>{i.getURL(),s(e==="media"||e==="mediaKeySystem"||e==="geolocation"||e==="notifications"||e==="fullscreen")}),t.maximize(),t.show(),t.setFocusable(!0),process.env.VITE_DEV_SERVER_URL?t.loadURL(process.env.VITE_DEV_SERVER_URL):t.loadFile("dist/index.html"),p.ipcMain.handle("save-model-file",async(i,e,s)=>{try{const r=`${m()}-${s}`,o=u.join(b,r);return c.writeFileSync(o,Buffer.from(e)),`app-file://${o}`}catch(r){throw console.error("Error saving model file:",r),r}}),p.ipcMain.handle("save-image-file",async(i,e,s)=>{try{const r=`${m()}-${s}`,o=u.join(y,r);return c.writeFileSync(o,Buffer.from(e)),`app-file://${o}`}catch(r){throw console.error("Error saving image file:",r),r}}),p.ipcMain.handle("test-file-access",async(i,e)=>{try{const s=c.existsSync(e);if(s){const r=c.statSync(e);return{exists:s,size:r.size,isFile:r.isFile()}}return{exists:s}}catch(s){throw console.error(`Erro ao verificar arquivo ${e}:`,s),s}}),p.ipcMain.handle("read-file-as-buffer",async(i,e)=>{try{if(!c.existsSync(e))throw new Error(`Arquivo n√£o encontrado: ${e}`);return c.readFileSync(e)}catch(s){throw console.error(`Erro ao ler arquivo ${e}:`,s),s}})});
