"use strict";const p=require("electron"),u=require("path"),c=require("fs"),m=require("crypto"),l=[];for(let t=0;t<256;++t)l.push((t+256).toString(16).slice(1));function v(t,o=0){return(l[t[o+0]]+l[t[o+1]]+l[t[o+2]]+l[t[o+3]]+"-"+l[t[o+4]]+l[t[o+5]]+"-"+l[t[o+6]]+l[t[o+7]]+"-"+l[t[o+8]]+l[t[o+9]]+"-"+l[t[o+10]]+l[t[o+11]]+l[t[o+12]]+l[t[o+13]]+l[t[o+14]]+l[t[o+15]]).toLowerCase()}const d=new Uint8Array(256);let f=d.length;function S(){return f>d.length-16&&(m.randomFillSync(d),f=0),d.slice(f,f+=16)}const h={randomUUID:m.randomUUID};function w(t,o,n){var s;if(h.randomUUID&&!t)return h.randomUUID();t=t||{};const e=t.random??((s=t.rng)==null?void 0:s.call(t))??S();if(e.length<16)throw new Error("Random bytes length must be >= 16");return e[6]=e[6]&15|64,e[8]=e[8]&63|128,v(e)}const g=u.join(p.app.getPath("userData"),"assets"),b=u.join(g,"models"),y=u.join(g,"images");function x(){[g,b,y].forEach(t=>{c.existsSync(t)||c.mkdirSync(t,{recursive:!0})})}p.app.whenReady().then(()=>{x(),p.protocol.registerFileProtocol("app-file",(n,e)=>{const s=n.url.substring(10);try{const r=decodeURI(s);if(console.log("Loading file via app-file protocol:",r),!c.existsSync(r))return console.error("File not found:",r),e({error:-2});const i=u.extname(r).toLowerCase();let a="application/octet-stream";return i===".jpg"||i===".jpeg"?a="image/jpeg":i===".png"?a="image/png":i===".gif"?a="image/gif":i===".webp"?a="image/webp":i===".svg"&&(a="image/svg+xml"),e({path:r,mimeType:a})}catch(r){return console.error("Protocol handler error:",r),e({error:-2})}});const t=new p.BrowserWindow({show:!0,transparent:!0,frame:!1,center:!0,hasShadow:!1,movable:!1,alwaysOnTop:!1,focusable:!0,icon:u.join(process.cwd(),"loco-icon.icns"),webPreferences:{sandbox:!0,webviewTag:!0,nodeIntegration:!1,contextIsolation:!0,preload:u.join(__dirname,"preload.js"),webSecurity:!0}});t.webContents.session.webRequest.onHeadersReceived((n,e)=>{n.url.startsWith("blob:")?e({responseHeaders:{...n.responseHeaders,"Access-Control-Allow-Origin":["*"],"Access-Control-Allow-Methods":["GET, POST, OPTIONS"],"Access-Control-Allow-Headers":["Content-Type, Authorization"],"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}}):e({responseHeaders:{...n.responseHeaders,"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}})}),t.webContents.session.webRequest.onBeforeRequest((n,e)=>{n.url.startsWith("app-file://")&&console.log("Allowing app-file request:",n.url),e({})});const o=p.session.fromPartition("persist:webviewsession");o.protocol.registerFileProtocol("app-file",(n,e)=>{const s=n.url.substring(10);try{const r=decodeURI(s);if(console.log("Loading file via app-file protocol (webview session):",r),!c.existsSync(r))return console.error("File not found:",r),e({error:-2});const i=u.extname(r).toLowerCase();let a="application/octet-stream";return i===".jpg"||i===".jpeg"?a="image/jpeg":i===".png"?a="image/png":i===".gif"?a="image/gif":i===".webp"?a="image/webp":i===".svg"&&(a="image/svg+xml"),e({path:r,mimeType:a})}catch(r){return console.error("Protocol handler error in webview session:",r),e({error:-2})}}),o.webRequest.onHeadersReceived((n,e)=>{e({responseHeaders:{...n.responseHeaders,"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}})}),o.setPermissionRequestHandler((n,e,s)=>{n.getURL(),s(e==="media"||e==="mediaKeySystem"||e==="geolocation"||e==="notifications"||e==="fullscreen")}),t.maximize(),t.show(),t.setFocusable(!0),process.env.VITE_DEV_SERVER_URL?t.loadURL(process.env.VITE_DEV_SERVER_URL):t.loadFile("dist/index.html"),p.ipcMain.handle("save-model-file",async(n,e,s)=>{try{const r=`${w()}-${s}`,i=u.join(b,r);return c.writeFileSync(i,Buffer.from(e)),`app-file://${i}`}catch(r){throw console.error("Error saving model file:",r),r}}),p.ipcMain.handle("save-image-file",async(n,e,s)=>{try{const r=`${w()}-${s}`,i=u.join(y,r);return c.writeFileSync(i,Buffer.from(e)),`app-file://${i}`}catch(r){throw console.error("Error saving image file:",r),r}}),p.ipcMain.handle("test-file-access",async(n,e)=>{try{const s=c.existsSync(e);if(console.log(`Verificando acesso ao arquivo: ${e} - Existe: ${s}`),s){const r=c.statSync(e);return{exists:s,size:r.size,isFile:r.isFile()}}return{exists:s}}catch(s){throw console.error(`Erro ao verificar arquivo ${e}:`,s),s}}),p.ipcMain.handle("read-file-as-buffer",async(n,e)=>{try{if(!c.existsSync(e))throw new Error(`Arquivo n√£o encontrado: ${e}`);return c.readFileSync(e)}catch(s){throw console.error(`Erro ao ler arquivo ${e}:`,s),s}})});
