"use strict";const i=require("electron"),g=require("path"),c=require("fs"),E=require("os"),R=require("crypto"),d=[];for(let t=0;t<256;++t)d.push((t+256).toString(16).slice(1));function O(t,l=0){return(d[t[l+0]]+d[t[l+1]]+d[t[l+2]]+d[t[l+3]]+"-"+d[t[l+4]]+d[t[l+5]]+"-"+d[t[l+6]]+d[t[l+7]]+"-"+d[t[l+8]]+d[t[l+9]]+"-"+d[t[l+10]]+d[t[l+11]]+d[t[l+12]]+d[t[l+13]]+d[t[l+14]]+d[t[l+15]]).toLowerCase()}const b=new Uint8Array(256);let h=b.length;function I(){return h>b.length-16&&(R.randomFillSync(b),h=0),b.slice(h,h+=16)}const C={randomUUID:R.randomUUID};function m(t,l,v){var e;if(C.randomUUID&&!t)return C.randomUUID();t=t||{};const r=t.random??((e=t.rng)==null?void 0:e.call(t))??I();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,O(r)}const f=g.join(E.homedir(),".loco"),y=g.join(f,"models"),S=g.join(f,"images"),p=g.join(f,"videos");function A(){try{c.existsSync(f)||c.mkdirSync(f),c.existsSync(y)||c.mkdirSync(y),c.existsSync(S)||c.mkdirSync(S),c.existsSync(p)||c.mkdirSync(p)}catch(t){console.error("Error creating app directories:",t)}}const u={log:(...t)=>{process.env.NODE_ENV==="development"&&console.log(...t)},error:(...t)=>{console.error(...t)}};i.app.whenReady().then(()=>{A(),i.protocol.registerFileProtocol("app-file",(r,e)=>{const n=r.url.substring(10);try{const o=decodeURI(n);if(!c.existsSync(o))return console.error("File not found:",o),e({error:-2});const s=g.extname(o).toLowerCase();let a="application/octet-stream";return s===".jpg"||s===".jpeg"?a="image/jpeg":s===".png"?a="image/png":s===".gif"?a="image/gif":s===".webp"?a="image/webp":s===".svg"&&(a="image/svg+xml"),e({path:o,mimeType:a})}catch(o){return console.error("Protocol handler error:",o),e({error:-2})}});const t=new i.BrowserWindow({show:!0,transparent:!0,frame:!1,center:!0,hasShadow:!1,movable:!0,alwaysOnTop:!0,focusable:!0,skipTaskbar:!0,titleBarStyle:"hidden",icon:g.join(process.cwd(),"loco-icon.icns"),webPreferences:{sandbox:!0,webviewTag:!0,nodeIntegration:!1,contextIsolation:!0,preload:g.join(__dirname,"preload.js"),webSecurity:!0}});t.setAlwaysOnTop(!0,"floating",1),t.webContents.session.webRequest.onHeadersReceived((r,e)=>{r.url.startsWith("blob:")?e({responseHeaders:{...r.responseHeaders,"Access-Control-Allow-Origin":["*"],"Access-Control-Allow-Methods":["GET, POST, OPTIONS"],"Access-Control-Allow-Headers":["Content-Type, Authorization"],"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}}):e({responseHeaders:{...r.responseHeaders,"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}})}),t.webContents.session.webRequest.onBeforeRequest((r,e)=>{r.url.startsWith("app-file://"),e({})});const l=i.session.fromPartition("persist:webviewsession");l.protocol.registerFileProtocol("app-file",(r,e)=>{const n=r.url.substring(10);try{const o=decodeURI(n);if(!c.existsSync(o))return console.error("File not found:",o),e({error:-2});const s=g.extname(o).toLowerCase();let a="application/octet-stream";return s===".jpg"||s===".jpeg"?a="image/jpeg":s===".png"?a="image/png":s===".gif"?a="image/gif":s===".webp"?a="image/webp":s===".svg"&&(a="image/svg+xml"),e({path:o,mimeType:a})}catch(o){return console.error("Protocol handler error in webview session:",o),e({error:-2})}}),l.webRequest.onHeadersReceived((r,e)=>{e({responseHeaders:{...r.responseHeaders,"Content-Security-Policy":["default-src 'self' app-file: file: data: blob: 'unsafe-inline' 'unsafe-eval' https://* http://*; media-src 'self' https://* http://* blob: app-file:; connect-src 'self' https://* http://* ws://* wss://* blob: app-file: data:; img-src 'self' data: blob: https://* http://* app-file:;"]}})}),l.setPermissionRequestHandler((r,e,n)=>{const o=r.getURL();u.log(`Permission request: ${e} for ${o}`),e==="media"||e==="mediaKeySystem"||e==="geolocation"||e==="notifications"||e==="fullscreen"||e==="display-capture"||e==="pointerLock"?(u.log(`Granting permission: ${e}`),n(!0)):(u.log(`Denying permission: ${e}`),n(!1))}),t.webContents.session.setPermissionRequestHandler((r,e,n)=>{r.getURL(),e==="media"||e==="mediaKeySystem"||e==="geolocation"||e==="notifications"||e==="fullscreen"||e==="display-capture"||e==="pointerLock"?(u.log(`Granting permission: ${e}`),n(!0)):(u.log(`Denying permission: ${e}`),n(!1))}),t.webContents.session.setPermissionCheckHandler((r,e)=>e==="media"||e==="pointerLock"),t.maximize(),t.show(),t.setFocusable(!0),t.setAlwaysOnTop(!0,"floating",1),P(t),process.env.VITE_DEV_SERVER_URL?t.loadURL(process.env.VITE_DEV_SERVER_URL):t.loadFile("dist/index.html"),setInterval(()=>{const r=i.screen.getCursorScreenPoint(),[e,n]=t.getPosition(),[o,s]=t.getSize();r.x>e&&r.x<e+o&&r.y>n&&r.y<n+s&&v(r.x-e,r.y-n)},300);const v=async(r,e)=>{const o=(await t.webContents.capturePage({x:r,y:e,width:1,height:1})).getBitmap();t.setIgnoreMouseEvents(!o[3])};setInterval(()=>{t.setAlwaysOnTop(!0,"floating",1)},1e3),i.ipcMain.handle("save-model-file",async(r,e,n)=>{try{const o=`${m()}-${n}`,s=g.join(y,o);return c.writeFileSync(s,Buffer.from(e)),`app-file://${s}`}catch(o){throw u.error("Error saving model file:",o),o}}),i.ipcMain.handle("save-image-file",async(r,e,n)=>{try{const o=`${m()}-${n}`,s=g.join(S,o);return c.writeFileSync(s,Buffer.from(e)),`app-file://${s}`}catch(o){throw console.error("Error saving image file:",o),o}}),i.ipcMain.handle("save-video-file",async(r,e,n)=>{try{const o=`${m()}-${n}`,s=g.join(p,o);return c.writeFileSync(s,Buffer.from(e)),`app-file://${s}`}catch(o){throw console.error("Error saving video file:",o),o}}),i.ipcMain.handle("list-videos-from-disk",async r=>{try{return{success:!0,videos:c.readdirSync(p).filter(s=>{const a=g.extname(s).toLowerCase();return[".mp4",".webm",".mov",".avi",".mkv"].includes(a)}).map(s=>{const a=g.join(p,s),w=c.statSync(a),x=s.includes("-")?s.substring(s.indexOf("-")+1):s;return{id:m(),fileName:x,url:`app-file://${a}`,thumbnailUrl:"",filePath:a,fileSize:w.size,createdAt:w.birthtime.toISOString(),modifiedAt:w.mtime.toISOString(),type:"video"}})}}catch(e){return u.error("Error listing videos from disk:",e),{success:!1,videos:[],error:e.message}}}),i.ipcMain.handle("test-file-access",async(r,e)=>{try{const n=c.existsSync(e);if(n){const o=c.statSync(e);return{exists:n,size:o.size,isFile:o.isFile()}}return{exists:n}}catch(n){throw console.error(`Erro ao verificar arquivo ${e}:`,n),n}}),i.ipcMain.handle("read-file-as-buffer",async(r,e)=>{try{if(!c.existsSync(e))throw new Error(`Arquivo nÃ£o encontrado: ${e}`);return c.readFileSync(e)}catch(n){throw u.error(`Erro ao ler arquivo ${e}:`,n),n}}),i.ipcMain.handle("get-screen-sources",async()=>{try{u.log("Electron: Fetching screen sources");const r=await i.desktopCapturer.getSources({types:["screen","window"],thumbnailSize:{width:150,height:150},fetchWindowIcons:!0});return u.log(`Electron: Found ${r.length} screen sources:`,r.map(e=>e.name)),r.map(e=>({id:e.id,name:e.name,display_id:e.display_id,thumbnail:e.thumbnail.toDataURL(),appIcon:e.appIcon?e.appIcon.toDataURL():null}))}catch(r){throw u.error("Electron: Error getting screen sources:",r),r}}),i.ipcMain.handle("reload-app",()=>{u.log("Reloading application..."),i.app.relaunch(),i.app.exit(0)}),i.ipcMain.handle("toggle-always-on-top",(r,e)=>(u.log(`Setting always-on-top: ${e}`),t.setAlwaysOnTop(e,"floating",1),t.isAlwaysOnTop())),i.app.on("will-quit",()=>{i.globalShortcut.unregisterAll()}),i.ipcMain.on("toggle-interview-assistant",()=>{t.webContents.send("global-shortcut","toggle-interview-assistant")}),i.ipcMain.on("capture-screenshot",()=>{t.webContents.send("global-shortcut","capture-screenshot")}),i.ipcMain.on("generate-solution",()=>{t.webContents.send("global-shortcut","generate-solution")})});function P(t){i.globalShortcut.unregisterAll(),i.globalShortcut.register("CommandOrControl+Shift+Space",()=>{u.log("Global shortcut triggered: CommandOrControl+Shift+Space"),t.isVisible()?t.hide():(t.show(),t.setAlwaysOnTop(!0,"floating",1))}),i.globalShortcut.register("CommandOrControl+B",()=>{u.log("Global shortcut triggered: CommandOrControl+B"),t.webContents.send("global-shortcut","toggle-interview-assistant")}),i.globalShortcut.register("CommandOrControl+H",()=>{u.log("Global shortcut triggered: CommandOrControl+H"),t.webContents.send("global-shortcut","capture-screenshot")}),i.globalShortcut.register("CommandOrControl+Return",()=>{u.log("Global shortcut triggered: CommandOrControl+Return"),t.webContents.send("global-shortcut","generate-solution")}),(!i.globalShortcut.isRegistered("CommandOrControl+Shift+Space")||!i.globalShortcut.isRegistered("CommandOrControl+B")||!i.globalShortcut.isRegistered("CommandOrControl+H")||!i.globalShortcut.isRegistered("CommandOrControl+Return"))&&u.error("Global shortcut registration failed")}
